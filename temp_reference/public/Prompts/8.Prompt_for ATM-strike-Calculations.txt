DHANHQ WEBSOCKET INSTRUMENT SUBSCRIPTION (ATM-AWARE)
READ CAREFULLY.
THIS PROMPT REPLACES ALL PREVIOUS INSTRUCTIONS.
NO OPTIMIZATION, PRUNING, OR REINTERPRETATION IS ALLOWED.

OBJECTIVE:
Subscribe to the approved instrument universe using DhanHQ API v2 WebSocket,
with correct ATM-based strike generation, strict Dhan compliance,
and zero manual ATM inputs.

üîí DHANHQ API v2 COMPLIANCE (MANDATORY)
Hard limits (DhanHQ v2):

‚Ä¢ Max WebSocket connections per user: 5
‚Ä¢ Max instrument subscriptions per WebSocket: 5,000
‚Ä¢ REST Quote APIs: 1 request per second
‚Ä¢ REST Data APIs (option chain, Greeks, margins): 5 requests per second

Violations may result in throttling or temporary IP blocking.

Implementation MUST:
‚Ä¢ Never exceed these limits
‚Ä¢ Use exponential backoff on reconnects
‚Ä¢ Avoid rapid subscribe/unsubscribe cycles
‚Ä¢ Centralize REST calls with caching
‚Ä¢ Never call REST per tick or per user action

üéØ APPROVED INSTRUMENT UNIVERSE (LOCKED & FINAL)
A) NSE ‚Äì INDEX OPTIONS (CE & PE mandatory)

NIFTY 50

Expiries: 8 weekly + 4 quarterly
Strikes per expiry: 100

BANKNIFTY
Expiries: current monthly + next 4 quarterly
Strikes per expiry: 100

SENSEX
Expiries: current 4 weekly + next 1 monthly
Strikes per expiry: 100

FINNIFTY
Expiries: current monthly + next 3 quarterly
Strikes per expiry: 50

MIDCPNIFTY
Expiries: current monthly + next 3 quarterly
Strikes per expiry: 50

BANKEX
Expiries: current monthly + next 3 quarterly
Strikes per expiry: 50

B) NSE ‚Äì STOCK OPTIONS
ALL NSE F&O stocks
Expiries: current monthly + next monthly
Strikes per expiry: 25 ( ATM + 12 up and 12 downside)
CE & PE mandatory


C) NSE ‚Äì STOCK FUTURES
Same NSE F&O stocks
Expiries: current monthly + next monthly

D) NSE ‚Äì EQUITY (CASH MARKET)
Top 1500 NSE equity stocks
One instrument per stock
No expiries, no strikes

E) MCX ‚Äì FUTURES
Include ONLY:
GOLD, GOLDM, GOLDMINI
SILVER, SILVERM, SILVERMINI
CRUDEOIL, NATURALGAS, COPPER

Expiries:
Current monthly + next monthly

F) MCX ‚Äì OPTIONS
Include ONLY:
CRUDEOIL
NATURALGAS
Rules:
Expiries: current monthly + next monthly
Strikes per expiry: 10
CE & PE mandatory

üîë ATM COMPUTATION & STRIKE GENERATION (CRITICAL)
ATM MUST NOT BE MANUALLY PROVIDED.

ATM is a computed value derived from live prices.
If ATM cannot be computed, STOP and DO NOT generate strikes.

ATM COMPUTATION RULE

For every underlying (index, stock, commodity):

1. Fetch underlying LTP
   ‚Ä¢ Prefer first WebSocket tick
   ‚Ä¢ Fallback: Market Quote REST (batched)

2. Read strike interval from instrument master

3. Compute:
   ATM = round(LTP / strike_interval) * strike_interval


Examples:

NIFTY LTP 25175 ‚Üí interval 50 ‚Üí ATM = 25200

BANKNIFTY LTP 48610 ‚Üí interval 100 ‚Üí ATM = 48600

‚ùå Do NOT sort strikes lexicographically
‚ùå Do NOT guess ATM
‚ùå Do NOT use first/lowest strike

üéØ STRIKE RANGE RULES (RELATIVE TO ATM)
Index Options (NIFTY, BANKNIFTY, SENSEX)

50 strikes below ATM

ATM

49 strikes above ATM
= 100 strikes

Index Options (FINNIFTY, MIDCPNIFTY, BANKEX)

25 strikes below ATM

ATM

24 strikes above ATM
= 50 strikes

NSE Stock Options

12 strikes below ATM

ATM

12 strikes above ATM
= 25 strikes

MCX Options

5 strikes below ATM

5 strikes above ATM
= 10 strikes

Strike spacing MUST be read from instrument master.
DO NOT hardcode intervals.

üîÑ DYNAMIC ATM BEHAVIOR (LIVE MARKET)
ATM may update dynamically using WebSocket ticks for logic & display.

BUT:

‚Ä¢ Strike subscriptions MUST remain FIXED intraday
‚Ä¢ Do NOT resubscribe strikes on every price move
‚Ä¢ Re-subscription allowed ONLY on:
  - Market open
  - Expiry rollover
  - Explicit ADMIN refresh

üö´ STABILITY & ANTI-DRIFT RULES
‚Ä¢ Do NOT auto-expand strike ranges
‚Ä¢ Do NOT reduce strike counts
‚Ä¢ Do NOT add extra expiries
‚Ä¢ Do NOT drop weekly options
‚Ä¢ Do NOT infer universe from search UI
‚Ä¢ Do NOT optimize for performance by pruning

üìä EXPECTED COUNTS (MANDATORY ASSERTION)
Index Options        ‚âà 5,600
Stock Options        ‚âà 10,000
Stock Futures        ‚âà   200
NSE Equities         ‚âà 1,000
MCX Futures          ‚âà    18
MCX Options          ‚âà    80
--------------------------------
TOTAL                ‚âà 16,900 instruments


After generation:

Assert count ‚âà expected

If mismatch ‚Üí STOP and report error

Do NOT auto-correct silently

üîå WEBSOCKET DISTRIBUTION

Max 5 WebSocket connections
Max 5,000 instruments per connection
Deterministic allocation
Maintain mapping: instrument_token ‚Üí websocket_id
Subscriptions must be idempotent on reconnect

‚úÖ SUCCESS CRITERIA

Implementation is COMPLETE only if:
ATM is computed automatically for every underlying
No manual ATM input exists anywhere
Strikes are correctly centered around ATM
~16,900 instruments are subscribed
No WebSocket exceeds limits
No subscription churn occurs intraday