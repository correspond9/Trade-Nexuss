Project Context
This is a multi-user paper trading terminal based on Indian exchanges (NSE, BSE, MCX) 
This rule is mandatory across:
‚Ä¢	backend logic
‚Ä¢	frontend UI
‚Ä¢	logs
‚Ä¢	comments
‚Ä¢	documentation

________________________________________
Objective
Implement a Dhan API Authentication Mode Switch System that allows an ADMIN to switch, at runtime, between:
1.	STATIC_IP Mode (API Key + Secret + Client ID)
2.	DAILY_TOKEN Mode (24-hour Authorization Token)
This must work in:
‚Ä¢	Development (local machine, no static IP)
‚Ä¢	Production (deployed server, static IP)
________________________________________
Core Rules (Non-Negotiable)
1.	System MUST always start in STATIC_IP mode
2.	DAILY_TOKEN mode is manual, admin-initiated
3.	Switching modes must be safe, explicit, and auditable
4.	Only one auth mode active at a time
5.	Market data & trading logic must NOT know auth details
6.	Auth switching is system-level, never per USER
________________________________________
DhanHQ v2 Authentication Modes (Exact Requirements)
üîê Mode 1: STATIC_IP (Primary)
Credentials Required
‚Ä¢	client_id
‚Ä¢	api_key
‚Ä¢	api_secret
Characteristics
‚Ä¢	Static IP must be whitelisted in Dhan
‚Ä¢	Long-running, production-grade
‚Ä¢	Default on every startup
Rules
‚Ä¢	MUST NOT send Authorization token header
‚Ä¢	All sessions created via API key/secret flow
________________________________________
üîê Mode 2: DAILY_TOKEN (Emergency / Dev)
Credentials Required
‚Ä¢	authorization_token
‚Ä¢	expiry_timestamp (tracked, not guessed)
Characteristics
‚Ä¢	No static IP required
‚Ä¢	Valid ~24 hours
‚Ä¢	Used for:
o	local development
o	production emergency continuity
Rules
‚Ä¢	MUST NOT send api_key / api_secret / client_id
‚Ä¢	Token entered manually by ADMIN
‚Ä¢	No auto-generation or silent refresh
________________________________________
Backend Architecture (Mandatory)
1Ô∏è‚É£ Auth Mode Enum
Create a single authoritative enum:
DHAN_AUTH_MODE = STATIC_IP | DAILY_TOKEN
Persist it in database or config store.
________________________________________
2Ô∏è‚É£ Credential Isolation (Critical)
Maintain two completely separate credential stores.
Static IP Store
‚Ä¢	client_id
‚Ä¢	api_key
‚Ä¢	api_secret
‚Ä¢	last_success_timestamp
Daily Token Store
‚Ä¢	authorization_token
‚Ä¢	expiry_time
‚Ä¢	last_used_time
‚ùå Never overwrite one with the other
‚ùå Never mix headers between modes
________________________________________
3Ô∏è‚É£ Adapter Strategy Pattern
Implement:
DhanAdapter
 ‚îú‚îÄ StaticIPAuthStrategy
 ‚îî‚îÄ DailyTokenAuthStrategy
Rules:
‚Ä¢	Only ONE strategy active
‚Ä¢	REST & WebSocket logic shared
‚Ä¢	Auth strategy decides headers exclusively
________________________________________
Startup Behavior (Mandatory)
On system startup:
1.	Attempt STATIC_IP mode
2.	If success ‚Üí data_state = LIVE
3.	If failure ‚Üí data_state = DEGRADED
4.	DO NOT auto-switch to DAILY_TOKEN
5.	Wait for ADMIN decision
________________________________________
Mode Switching Logic (Strictly Enforced)
üîÅ Switching: STATIC_IP ‚Üí DAILY_TOKEN
When ADMIN initiates switch:
1.	Freeze trading
2.	Pause all USERS
3.	Cancel pending limit orders
4.	Freeze Greeks
5.	data_state ‚Üí RECOVERING
6.	Tear down Static IP sessions
7.	Activate Daily Token adapter
8.	Validate token & expiry
9.	Reconnect REST + WebSocket
10.	Rebuild subscriptions
11.	data_state ‚Üí LIVE (EMERGENCY)
Set flags:
auth_mode = DAILY_TOKEN
data_authority = TEMPORARY
________________________________________
üö® While in DAILY_TOKEN Mode
Allowed:
‚Ä¢	Market data
‚Ä¢	Portfolio monitoring
‚Ä¢	Position viewing
Restricted (recommended):
‚Ä¢	New USER strategy deployments
‚Ä¢	High-frequency USER execution
‚Ä¢	Large position sizes
UI must show:
‚ö† Emergency Data Mode (Daily Token Active)
________________________________________
üîÅ Switching: DAILY_TOKEN ‚Üí STATIC_IP
1.	ADMIN/Super Admin's confirmation required
2.	Freeze trading
3.	Pause USERS
4.	Tear down token session
5.	Clear cached prices
6.	Reload REST snapshots
7.	Reconnect WebSocket (Static IP)
8.	Stabilization window:
o	NSE/BSE ‚Üí 3‚Äì5 seconds
o	MCX ‚Üí 10 seconds
9.	Resume trading
10.	auth_mode = STATIC_IP
11.	data_authority = PRIMARY
________________________________________
Dashboard / UI Requirements (ADMIN and Supe ADMIN ONLY)
Create ‚ÄúDhan API Configuration‚Äù panel.
Must display:
‚Ä¢	Current Auth Mode
‚Ä¢	Data Authority (PRIMARY / TEMPORARY)
‚Ä¢	Token expiry countdown (if applicable)
‚Ä¢	Time since last switch
Must allow:
‚Ä¢	Switching auth mode
‚Ä¢	Editing credentials per mode
‚Ä¢	Mandatory ‚ÄúReason for Switch‚Äù input
________________________________________
Data State Integration
Auth switching must integrate with system data states:
‚Ä¢	LIVE
‚Ä¢	DEGRADED
‚Ä¢	FROZEN
‚Ä¢	RECOVERING
Rule:
Trading allowed ONLY if data_state == LIVE
________________________________________
Logging & Audit (Mandatory)
Every auth switch must log:
timestamp
admin_username
from_auth_mode
to_auth_mode
reason
active_user_positions_count
data_state
Logs must be immutable.
________________________________________
Environment Compatibility
‚Ä¢	Same codebase for Development & Production
‚Ä¢	No environment-based branching
‚Ä¢	Behavior controlled only by:
o	auth_mode
o	credentials
o	admin action
________________________________________
Explicit Non-Goals
‚ùå No automatic fallback
‚ùå No per-USER auth mode
‚ùå No parallel auth modes
‚ùå No silent switching
________________________________________
Final Acceptance Criteria
Implementation is complete and correct only if:
‚Ä¢	System always boots in STATIC_IP mode
‚Ä¢	ADMIN/Super Admin can switch modes live
‚Ä¢	Market data continuity is preserved safely
‚Ä¢	USERS never trade on stale data
‚Ä¢	DhanHQ v2 auth rules are strictly followed

