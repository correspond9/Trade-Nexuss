STEP 1: AUTHORITATIVE EXPIRY SOURCE (MANDATORY)
‚Ä¢ Instrument master MUST NOT be used to determine expiries.
‚Ä¢ Instrument master is metadata-only.
‚Ä¢ Expiry dates, lot sizes, strike intervals MUST be fetched dynamically from Dhan Option Chain APIs.

EXPLICITLY FORBIDDEN
‚Ä¢ Do NOT read expiry dates from instrument master
‚Ä¢ Do NOT hardcode expiry calendars
‚Ä¢ Do NOT assume monthly/weekly patterns
‚Ä¢ Do NOT infer expiry from symbol names

OPTION CHAIN CONSTRUCTION (UPDATED FLOW)
Expiry List API (authoritative)
   ‚Üì
Select required expiries
   ‚Üì
Option Chain REST (per expiry)
   ‚Üì
Extract strikes, tokens, Greeks, OI
   ‚Üì
Subscribe to WebSocket for live prices


Why is this required?
‚Ä¢ Exchange expiries change
‚Ä¢ Weekly schedules shift
‚Ä¢ Holidays alter expiries
‚Ä¢ Static masters become stale


SUCCESS CONDITION
The fix is COMPLETE only if:

No expiry comes from instrument master
All expiries match live exchange contracts
Option chain requests succeed for every expiry
No ‚Äúinstrument not found‚Äù or empty chain errors occur


STEP 2 ‚Äî DETERMINE EXPIRY DATES (SMARTLY)

For each underlying:

‚Ä¢ Read all expiries from instrument master
‚Ä¢ Select expiries based on rules:

Examples:

Weekly indices ‚Üí next N weeklies

Monthly instruments ‚Üí current + next monthly

Quarterly ‚Üí next N quarterlies

MCX ‚Üí current + next monthly

Store selected expiries in:

expiry_registry


STEP 3 ‚Äî COMPUTE ATM (AUTOMATICALLY)

ATM MUST NEVER BE MANUAL.

For every underlying (index / stock / commodity):

Fetch LTP

‚Ä¢ Prefer WebSocket first tick
‚Ä¢ Fallback: Market Quote REST (batched)

Read strike interval

‚Ä¢ From instrument_master_cache

Compute ATM
ATM = round(LTP / strike_interval) * strike_interval


Examples:
‚Ä¢ NIFTY LTP 25175 ‚Üí interval 50 ‚Üí ATM 25200
‚Ä¢ BANKNIFTY LTP 48610 ‚Üí interval 100 ‚Üí ATM 48600

If LTP is unavailable:
‚Ä¢ STOP
‚Ä¢ Do NOT guess ATM
‚Ä¢ Log error

Store ATM in:

atm_registry


STEP 4 ‚Äî GENERATE STRIKES (RULE-BASED)

Strikes must be generated ONLY relative to ATM.

Strike rules:

‚Ä¢ NIFTY / BANKNIFTY / SENSEX
‚Üí 50 below + ATM + 49 above = 100

‚Ä¢ FINNIFTY / MIDCPNIFTY / BANKEX
‚Üí 25 below + ATM + 24 above = 50

‚Ä¢ NSE Stock Options
‚Üí 12 below + ATM + 12 above = 25

‚Ä¢ MCX Options
‚Üí 5 below + 5 above = 10

Strike spacing MUST come from instrument master.

DO NOT:
‚Ä¢ sort lexicographically
‚Ä¢ pick first/lowest strike
‚Ä¢ expand ranges intraday


STEP 5 ‚Äî BUILD OPTION CHAIN SKELETON (REST)

For each:
‚Ä¢ underlying
‚Ä¢ expiry

Call DhanHQ REST Option Chain API:

POST /api/v2/optionchain
{
  "UnderlyingScrip": "<name>",
  "UnderlyingSeg": "<segment>",
  "Expiry": "<YYYY-MM-DD>"
}


From REST response, build Option Chain Skeleton:

option_chain_cache[underlying][expiry] = {
  underlying,
  expiry,
  lot_size,
  strike_interval,
  atm_strike,
  strikes: {
    strike_price: {
      CE: {
        token,
        ltp,
        bid,
        ask,
        oi,
        volume,
        iv,
        greeks
      },
      PE: {
        token,
        ltp,
        bid,
        ask,
        oi,
        volume,
        iv,
        greeks
      }
    }
  },
  last_updated
}


REST provides:
‚Ä¢ OI
‚Ä¢ Greeks
‚Ä¢ IV
‚Ä¢ initial LTP
‚Ä¢ metadata



STEP 6 ‚Äî WEBSOCKET SUBSCRIPTIONS

From option_chain_cache:
‚Ä¢ Extract ALL option tokens
‚Ä¢ Group tokens deterministically
‚Ä¢ Max 5,000 per WebSocket
‚Ä¢ Max 5 connections

Connect to:

wss://ws.dhan.co/v2/market


Subscribe format:

{
  "action": "subscribe",
  "symbols": [
    "segment|security_id|instrument_token"
  ]
}


Maintain:

token ‚Üí websocket_id mapping



STEP 7 ‚Äî MERGE LIVE DATA (WEBSOCKET)

On each tick:
‚Ä¢ Identify instrument token
‚Ä¢ Locate strike in option_chain_cache
‚Ä¢ Update ONLY:

LTP

Bid

Ask

Volume (if present)

DO NOT:
‚Ä¢ regenerate strikes
‚Ä¢ rebuild chain
‚Ä¢ resubscribe

Greeks remain from REST until refreshed periodically.

STEP 8 ‚Äî CENTRAL CACHE (CRITICAL)

ALL option chain data MUST live in:

option_chain_cache (in-memory + Redis fallback)


Frontend pages MUST:
‚Ä¢ Read ONLY from this cache
‚Ä¢ NEVER call Dhan APIs

This ensures:
‚Ä¢ Single data source
‚Ä¢ Consistent prices
‚Ä¢ No rate-limit issues

üîÅ STEP 9 ‚Äî PERIODIC REFRESH RULES

‚Ä¢ Greeks / OI refresh ‚Üí REST every 30‚Äì60 seconds
‚Ä¢ ATM recalculation ‚Üí logical, continuous
‚Ä¢ Strike regeneration ‚Üí ONLY on:

Market open

Expiry rollover

Admin manual refresh

üåê STEP 10 ‚Äî SERVE FRONTEND FROM CACHE

Expose FastAPI endpoints like:

GET /optionchain/live?underlying=NIFTY&expiry=2026-04-30


Response must come ONLY from:

option_chain_cache

üö´ STRICT NON-NEGOTIABLE RULES
‚Ä¢ No manual ATM input
‚Ä¢ No per-user REST calls
‚Ä¢ No per-tick REST calls
‚Ä¢ No UI-driven subscriptions
‚Ä¢ No strike guessing
‚Ä¢ No silent pruning

‚úÖ SUCCESS CRITERIA

System is COMPLETE only if:

‚úî Option chains are built once
‚úî Updated in real time
‚úî Stored centrally
‚úî Served to all UI pages
‚úî ATM is automatic
‚úî Dhan limits are never breached